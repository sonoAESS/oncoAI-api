<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>OncoAI Plataforma - Predicción de Supervivencia</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
        form { margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; border-radius: 6px; }
        label { display: inline-block; width: 160px; margin: 2px 5px; }
        input[type="number"], input[type="text"], input[type="password"], input[type="file"] {
            padding: 5px; width: 150px;
        }
        button { margin-top: 10px; padding: 8px 20px; cursor: pointer; }
        .field-group { margin-bottom: 5px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 4px; color: #007bff; }
        #result, #batchResult, #loginResult { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>OncoAI Plataforma - Predicción de Supervivencia 3 años</h1>

    <section id="login-section">
        <h2>Login para obtener Token</h2>
        <form id="loginForm">
            <label>Usuario:</label>
            <input type="text" id="username" required value="oncouser" /><br/>
            <label>Contraseña:</label>
            <input type="password" id="password" required value="ai2025" /><br/>
            <button type="submit">Obtener Token</button>
        </form>
        <div id="loginResult"></div>
    </section>

    <section id="manual-section" style="display:none;">
        <h2>Predicción manual</h2>
        <form id="predictForm">
            <div id="fieldsContainer"></div>
            <button type="submit">Predecir supervivencia</button>
        </form>
        <div id="result"></div>
    </section>

    <section id="batch-section" style="display:none;">
        <h2>Predicción masiva por archivo CSV/Excel</h2>
        <form id="batchForm" enctype="multipart/form-data">
            <input type="file" id="fileInput" accept=".csv,.xls,.xlsx" required />
            <button type="submit">Predecir batch</button>
        </form>
        <div id="batchResult"></div>
    </section>

    <script>
        const apiBaseUrl = "http://127.0.0.1:8000";

        const requiredFields = [
            'B2M_expression', 'B2M_scna', 'C1QB_expression', 'C1QB_scna',
            'C1QC_expression', 'C1QC_scna', 'CASP1_expression', 'CASP1_scna',
            'CD2_expression', 'CD2_scna', 'CD3E_expression', 'CD3E_scna',
            'CD4_expression', 'CD4_scna', 'CD74_expression', 'CD74_scna',
            'FCER1G_expression', 'FCER1G_scna', 'FCGR3A_expression', 'FCGR3A_scna',
            'IL10_expression', 'IL10_scna', 'LCK_expression', 'LCK_scna',
            'LCP2_expression', 'LCP2_scna', 'LYN_expression', 'LYN_scna',
            'PTPRC_expression', 'PTPRC_scna', 'SERPING1_expression', 'SERPING1_scna'
        ];

        // Crear inputs dinámicos para predicción manual
        const fieldsContainer = document.getElementById("fieldsContainer");
        requiredFields.forEach(field => {
            let div = document.createElement("div");
            div.className = "field-group";
            let label = document.createElement("label");
            label.textContent = field + ": ";
            let input = document.createElement("input");
            input.type = "number";
            input.step = "any";
            input.name = field;
            input.required = true;
            input.value = 0;
            div.appendChild(label);
            div.appendChild(input);
            fieldsContainer.appendChild(div);
        });

        // Obtener token del localStorage si existe
        function getToken() {
            return localStorage.getItem("oncoai_token");
        }

        // Guardar token en localStorage
        function setToken(token) {
            localStorage.setItem("oncoai_token", token);
        }

        // Mostrar secciones segun login
        function showSections(show) {
            document.getElementById("manual-section").style.display = show ? "block" : "none";
            document.getElementById("batch-section").style.display = show ? "block" : "none";
            document.getElementById("login-section").style.display = show ? "none" : "block";
        }

        // Verificar si token está en storage para mostrar formularios directamente
        if (getToken()) {
            showSections(true);
            document.getElementById("loginResult").textContent = "Token cargado desde almacenamiento.";
        }

        // Login form
        document.getElementById("loginForm").onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            try {
                const resp = await fetch(apiBaseUrl + "/token", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams({username, password})
                });
                if (!resp.ok) {
                    const errText = await resp.text();
                    throw new Error(errText);
                }
                const data = await resp.json();
                setToken(data.access_token);
                document.getElementById("loginResult").textContent = "Login exitoso. Token guardado.";
                showSections(true);
            } catch (error) {
                document.getElementById("loginResult").textContent = "Error: " + error.message;
            }
        };

        // Predict form
        document.getElementById("predictForm").onsubmit = async (e) => {
            e.preventDefault();
            const token = getToken();
            if (!token) {
                alert("Debes iniciar sesión primero para obtener un token");
                return;
            }
            const features = requiredFields.map(field => parseFloat(document.querySelector(`[name="${field}"]`).value));
            try {
                const resp = await fetch(apiBaseUrl + "/predict/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({features})
                });
                if (!resp.ok) {
                    const errText = await resp.text();
                    throw new Error(errText);
                }
                const data = await resp.json();
                document.getElementById("result").textContent = 
                    `Probabilidad de supervivencia > 3 años: ${(data.survival_probability*100).toFixed(2)}%`;
            } catch (error) {
                document.getElementById("result").textContent = "Error: " + error.message;
            }
        };

        // Batch predict form
        document.getElementById("batchForm").onsubmit = async (e) => {
            e.preventDefault();
            const token = getToken();
            if (!token) {
                alert("Debes iniciar sesión primero para obtener un token");
                return;
            }
            const fileInput = document.getElementById("fileInput");
            if (fileInput.files.length === 0) {
                alert("Selecciona un archivo CSV o Excel");
                return;
            }
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const resp = await fetch(apiBaseUrl + "/predict/batch_predict", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    body: formData
                });
                if (!resp.ok) {
                    const errText = await resp.text();
                    throw new Error(errText);
                }
                const data = await resp.json();
                let html = "Predicciones batch:<br/>";
                data.predictions.forEach(r => {
                    html += `Fila ${r.row}: ${(r.survival_probability * 100).toFixed(2)}%<br/>`;
                });
                document.getElementById("batchResult").innerHTML = html;
            } catch (error) {
                document.getElementById("batchResult").textContent = "Error: " + error.message;
            }
        };
    </script>
</body>
</html>
